name: Full Audit

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pre-commit

      - name: Run check-repo
        id: check_repo
        run: python scripts/check-repo.py
        continue-on-error: true

      - name: Run repo-scan
        id: repo_scan
        run: python scripts/repo-scan.py
        continue-on-error: true

      - name: Run pre-commit
        id: precommit
        run: pre-commit run -a
        continue-on-error: true

      - name: Run actionlint
        id: actionlint
        run: |
          curl -sSfL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash | bash
          ./actionlint
        continue-on-error: true

      - name: Generate Audit Summary
        run: |
          echo "# ðŸ“‹ Full Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| check-repo | ${{ steps.check_repo.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| repo-scan | ${{ steps.repo_scan.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| pre-commit | ${{ steps.precommit.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| actionlint | ${{ steps.actionlint.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Triggered: $(date -u)*" >> $GITHUB_STEP_SUMMARY
          echo "*Commit: ${{ github.sha }}*" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any check failed
        if: steps.check_repo.outcome == 'failure' || steps.repo_scan.outcome == 'failure' || steps.precommit.outcome == 'failure' || steps.actionlint.outcome == 'failure'
        run: exit 1
